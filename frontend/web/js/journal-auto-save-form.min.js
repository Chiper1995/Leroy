JournalAutoSaveForm=function(e,o){null!=e.data("journalAutoSaveForm")&&e.data("journalAutoSaveForm").destroy(),this.$element=e,this.options=$.extend({},{autoSaveUrl:null,delayBeforeSend:1e3,delayBetweenSend:5e3,delayAlert:3e3},o),this.timeoutReference=null,this.saveInProcess=!1,this.dataChanged=!1,this.$versionToken=this.$element.find("#journal-version_token"),this.$photos=this.$element.find("#journal-photos"),this.$goods=this.$element.find("#journal-goods"),this.registerEvents(),e.data("journalAutoSaveForm",this)},JournalAutoSaveForm.prototype.destroy=function(){this.$element.off("change.journalAutoSaveForm"),this.$photos.off("PhotoUpload:delete.journalAutoSaveForm"),this.$goods.off("Goods:change.journalAutoSaveForm")},JournalAutoSaveForm.prototype.registerEvents=function(){var e=this;this.$element.on("change.journalAutoSaveForm","input, select, textarea",function(){e.dataChangedHandler()}),this.$photos.on("PhotoUpload:delete.journalAutoSaveForm",function(){e.dataChangedHandler()}),this.$goods.on("Goods:change.journalAutoSaveForm",function(){e.dataChangedHandler()})},JournalAutoSaveForm.prototype.dataChangedHandler=function(){this.dataChanged=!0,this.saveInProcess||this.save()},JournalAutoSaveForm.prototype.save=function(){var e=this;this.timeoutReference&&clearTimeout(this.timeoutReference),this.timeoutReference=setTimeout(function(){e.sendDataToServer()},this.options.delayBeforeSend)},JournalAutoSaveForm.prototype.sendDataToServer=function(){var o=this;if(this.timeoutReference=null,!this.saveInProcess){this.saveInProcess=!0,this.dataChanged=!1;var e=this.$element.serialize();$.ajax({type:"POST",url:this.options.autoSaveUrl,data:e,success:function(e){void 0!==e&&void 0!==e.result?("ok"!=e.result?console.log("JournalAutoSaveForm.Save: result="+e.result+"; msg="+e.msg):o.showAlertMsg(),e.version_token&&o.refreshVersionToken(e.version_token)):console.log("JournalAutoSaveForm.Save: Something wrong!")},complete:function(){setTimeout(function(){o.saveInProcess=!1,o.dataChanged&&o.sendDataToServer()},o.options.delayBetweenSend)}})}},JournalAutoSaveForm.prototype.showAlertMsg=function(){var e=$('<div class="alert alert-info fade in" style="position: fixed; right: 10px; top: 10px; z-index: 10000;"><button type="button" class="close" style="margin-left: 15px" data-dismiss="alert" aria-hidden="true">×</button>Запись сохранена</div>').appendTo("body");setTimeout(function(){e.find(".close").click()},this.options.delayAlert)},JournalAutoSaveForm.prototype.refreshVersionToken=function(e){this.$versionToken.val(e)},null==$.fn.journalAutoSaveForm&&($.fn.journalAutoSaveForm=function(o){if("object"==typeof(o=o||{}))return this.each(function(){var e=$.extend(!0,{},o);new JournalAutoSaveForm($(this),e)}),this;throw new Error("Invalid arguments for JournalAutoSaveForm: "+o)});